<tool id="cfmid" name="CFM-ID" version="0.1.0">
    <description></description>
    <requirements>
        <requirement type="package" version="1.3.0">argparse</requirement>
    </requirements>
    <command detect_errors="exit_code">
    <![CDATA[
        #set $tool_directory = $getVar('__tool_directory__', '../../../../tools/msmstools')
        export LD_LIBRARY_PATH=/home/jcapelladesto/cfmtest/cfm-id/opt/boost_1_55_0:/home/jcapelladesto/cfmtest/cfm-id/opt/RDKit_2013_09_1/lib:/home/jcapelladesto/cfmtest/cfm-id/opt/lpsolve55/bin/ux64
        &&
        python $tool_directory/cfmid.py
            --input "$input"
            --db_local '$db_local'
            --ppm_db $ppm_db
            --num_highest $num_highest
            --ppm_mass_tol $ppm_mass_tol
            --abs_mass_tol $abs_mass_tol
            --polarity $polarity
            --score_type $score_type
            --results '$results'
            --tool_directory '$tool_directory'
    ]]></command>
    <inputs>
        <param name="input" type="data" format="msp,txt" label="MSP file (Output from Create MSP tool)" argument="--input"/>
        <param name="db_local" type="data" format="csv" label="Local Database (CSV)" argument="--db_local"/>
        <param name="ppm_db" type="float" value="10.0" label="Mass tolerance in ppm to use when matching candidates in the database" argument="--ppm_db"/>
        <param name="num_highest" type="integer" value="10" label="The number of (ranked) candidates to return" argument="--num_highest"/>
        <param name="ppm_mass_tol" type="float" value="10.0" label="Mass tolerance in ppm to use when matching peaks within the dot product comparison" argument="--ppm_mass_tol"/>
        <param name="abs_mass_tol" type="float" value="0.01" label="Mass tolerance in abs Da to use when matching peaks within the dot product comparison (will use higher resulting tolerance of ppm and abs)" argument="--abs_mass_tol"/>
        <param name="polarity" type="select" label="Ion Mode" argument="--polarity">
            <option value="pos" selected="true">Positive</option>
            <option value="neg">Negative</option>
        </param>
        <param name="score_type" type="select" label="The type of scoring function to use when comparing spectra" argument="--score_type">
            <option value="Jaccard" selected="true">Jaccard</option>
            <option value="DotProduct">DotProduct</option>
        </param>
        <param name="prob_thresh" type="float" value="0.001" label="The probability below which to prune unlikely fragmentations" argument="--prob_thresh"/>
    </inputs>
    <outputs>
        <data name="results" format="tabular" label="${tool.name} results of ${input.name}" />
    </outputs>
    <tests>
        <test>
            <param name="input" value="input.msp"/>
            <param name="db_local" value="demo_db.csv"/>
            <output name="results" file="cfmid.tabular"/>
        </test>
    </tests>
    <help>
------
CFM-ID
------

Description
-----------

Galaxy wrapper for CFM-ID tool. CFM-ID provides a method for accurately and efficiently identifying metabolites in spectra generated by electrospray tandem mass spectrometry (ESI-MS/MS). The program uses Competitive Fragmentation Modeling to produce a probabilistic generative model for the MS/MS fragmentation process and machine learning techniques to adapt the model parameters from data.

Website: http://cfmid.wishartlab.com/

Parameters
----------

**\1. MSP file**

MSP file created using *Create MSP*

**\2. CSV Database containing InChI (or SMILES)**

The database is used to fetch the candidates for the precursor. The candidates are "in silico" fragmented by CFMID and then the spectras are matched against those in the MSP.

Custom database file in **CSV** format with the following structure:

+-------------+------------------+----------+---------------------------------------------+----------------------+
| Identifier  | MonoisotopicMass | SMILES   | InChI                                       | Name                 |
+-------------+------------------+----------+---------------------------------------------+----------------------+
| HMDB0000123 | 75.03202841      | NCC(O)=O | InChI=1S/C2H5NO2/c3-1-2(4)5/h1,3H2,(H,4,5)  | Glycine              |
+-------------+------------------+----------+---------------------------------------------+----------------------+
| HMDB0002151 | 78.0139355       | CS(C)=O  | InChI=1S/C2H6OS/c1-4(2)3/h1-2H3             | Dimethyl sulfoxide   |
+-------------+------------------+----------+---------------------------------------------+----------------------+
| ...         | ...              | ...      | ...                                         | ...                  |
+-------------+------------------+----------+---------------------------------------------+----------------------+

**\3. Mass tolerance in ppm to use when matching candidates to the database**

**\4. Mass tolerance in ppm to use when matching peaks within the Dot Product comparison**

**\5. The number of (ranked) candidates to return**

Set the top X candidates to return or use "-1" to return all of them, including those that the score is 0.

**\6. Ion Mode**

* Positive: For [M+H]+ adducts.

* Negative: For [M-H]- adducts.

**\7. The type of scoring function to use when comparing spectra**

* Jaccard: The Jaccard coefficient measures similarity between finite sample sets, and is defined as the size of the intersection divided by the size of the union of the sample sets.

* Dot Product: The product of the Euclidean magnitudes of the two vectors and the cosine of the angle between them.


Developers and contributors
---------------------------

- **Jordi Capellades (j.capellades.to@gmail.com) - Universitat Rovira i Virgili (SP)**
- **Ralf Weber (r.j.weber@bham.ac.uk) - University of Birmingham (UK)**

    </help>
    <citations>
        <citation type="doi">10.1093/nar/gku436</citation>
    </citations>
</tool> 
