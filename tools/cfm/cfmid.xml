<tool id="cfmid" name="CFM-ID" version="33">
    <description></description>
    <requirements>
        <requirement type="package" version="33">cfm</requirement>
    </requirements>
    <command detect_errors="exit_code">
    <![CDATA[
        #set $tool_directory = $getVar('__tool_directory__', '../../../../tools/cfm')
        python $tool_directory/cfmid.py
            --input "$input"
            --db_local '$db_local'
            --ppm_db $ppm_db
            --num_highest $num_highest
            --ppm_mass_tol $ppm_mass_tol
            --abs_mass_tol $abs_mass_tol
            --polarity $polarity
            --score_type $score_type
            --results '$results'
            --tool_directory '$tool_directory'
    ]]></command>
    <inputs>
        <param argument="--input" type="data" format="msp,txt" label="MSP file (Output from Create MSP tool)"/>
        <param argument="--db_local" type="data" format="tsv,tabular" label="Local Database (CSV)"/>
        <param argument="--ppm_db" type="float" value="5.0" label="Mass tolerance in ppm to use when matching candidates in the database"/>
        <param argument="--num_highest" type="integer" value="10" label="The number of (ranked) candidates to return"/>
        <param argument="--ppm_mass_tol" type="float" value="10.0" label="Mass tolerance in ppm to use when matching peaks within the dot product comparison"/>
        <param argument="--abs_mass_tol" type="float" value="0.01" label="Mass tolerance in abs Da to use when matching peaks within the dot product comparison (will use higher resulting tolerance of ppm and abs)"/>
        <param argument="--polarity" type="select" label="Ion Mode">
            <option value="pos" selected="true">Positive</option>
            <option value="neg">Negative</option>
        </param>
        <param argument="--score_type" type="select" label="The type of scoring function to use when comparing spectra">
            <option value="Jaccard" selected="true">Jaccard index</option>
            <option value="DotProduct">Dot Product</option>
        </param>
        <param argument="--prob_thresh" type="float" value="0.001" label="The probability below which to prune unlikely fragmentations"/>
    </inputs>
    <outputs>
        <data name="results" format="tsv" label="${tool.name} on ${on_string}: Annotations" />
    </outputs>
    <tests>
        <test>
            <param name="input" value="input.msp"/>
            <param name="db_local" value="db.tsv"/>
            <param name="ppm_db" value="10.0"/>
            <output name="results" file="annotations.tsv"/>
        </test>
    </tests>
    <help>
------
CFM-ID
------

Description
-----------

Galaxy wrapper for CFM-ID tool. CFM-ID provides a method for accurately and efficiently identifying metabolites in spectra generated by electrospray tandem mass spectrometry (ESI-MS/MS). The program uses Competitive Fragmentation Modeling to produce a probabilistic generative model for the MS/MS fragmentation process and machine learning techniques to adapt the model parameters from data.

Website: http://cfmid.wishartlab.com/

Parameters
----------

**\1. MSP file**

MSP file

**\2. Database containing InChI (or SMILES)**

The database is used to fetch the candidates for the precursor. The candidates are "in silico" fragmented by CFMID and then the spectras are matched against those in the MSP.

Custom database file in **tsv** or "tabular" format with the following structure:

+-------------+------------------+----------+---------------------------------------------+----------------------+
| Identifier  | MonoisotopicMass | SMILES   | InChI                                       | Name                 |
+-------------+------------------+----------+---------------------------------------------+----------------------+
| HMDB0000123 | 75.03202841      | NCC(O)=O | InChI=1S/C2H5NO2/c3-1-2(4)5/h1,3H2,(H,4,5)  | Glycine              |
+-------------+------------------+----------+---------------------------------------------+----------------------+
| HMDB0002151 | 78.0139355       | CS(C)=O  | InChI=1S/C2H6OS/c1-4(2)3/h1-2H3             | Dimethyl sulfoxide   |
+-------------+------------------+----------+---------------------------------------------+----------------------+
| ...         | ...              | ...      | ...                                         | ...                  |
+-------------+------------------+----------+---------------------------------------------+----------------------+

**\3. Mass tolerance in ppm to use when matching candidates to the database**

**\4. Mass tolerance in ppm to use when matching peaks within the Dot Product comparison**

**\5. The number of (ranked) candidates to return**

Set the top X candidates to return or use "-1" to return all of them, including those that the score is 0.

**\6. Ion Mode**

* Positive: For [M+H]+ adduct.

* Negative: For [M-H]- adduct.

**\7. The type of scoring function to use when comparing spectra**

* Jaccard: The Jaccard coefficient measures similarity between finite sample sets, and is defined as the size of the intersection divided by the size of the union of the sample sets.

* Dot Product: The product of the Euclidean magnitudes of the two vectors and the cosine of the angle between them.


Developers and contributors
---------------------------

- **Jordi Capellades (j.capellades.to@gmail.com) - Universitat Rovira i Virgili (SP)**
- **Matthias Bernt** (m.bernt@ufz.de) - Helmholtz Centre for Environmental Research - UFZ
- **Ralf Weber (r.j.weber@bham.ac.uk) - University of Birmingham (UK)**
    </help>
    <citations>
        <citation type="doi">10.1093/nar/gku436</citation>
    </citations>
</tool> 
